name: Build and Package

on:
  push:
    branches:
      - alpha-build-packaging-tests
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

env:
  GO_VERSION: '1.24.1'
  FYNE_VERSION: 'v2.5.5'

jobs:
  build:
    name: Build ${{ matrix.os }}-${{ matrix.arch }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Windows
          - os: windows-latest
            arch: amd64
            goos: windows
            goarch: amd64
            suffix: .exe
            package_cmd: package -os windows -release -sourceDir ./cmd/blindbit-desktop
            artifact_name: BlindBit-windows-amd64
          
          # Linux
          - os: ubuntu-latest
            arch: amd64
            goos: linux
            goarch: amd64
            suffix: 
            package_cmd: package -os linux -release -sourceDir ./cmd/blindbit-desktop
            artifact_name: BlindBit-linux-amd64
          
          - os: ubuntu-latest
            arch: arm64
            goos: linux
            goarch: arm64
            suffix:
            package_cmd: package -os linux -release -sourceDir ./cmd/blindbit-desktop
            artifact_name: BlindBit-linux-arm64
          
          # macOS
          # Note: macOS Intel (amd64) builds on ARM runners may require special handling
          # Fyne may not fully support cross-compilation for macOS Intel on ARM
          - os: macos-14
            arch: amd64
            goos: darwin
            goarch: amd64
            suffix:
            package_cmd: package -os darwin -release -sourceDir ./cmd/blindbit-desktop
            artifact_name: BlindBit-macos-amd64
          
          - os: macos-14
            arch: arm64
            goos: darwin
            goarch: arm64
            suffix:
            package_cmd: package -os darwin -release -sourceDir ./cmd/blindbit-desktop
            artifact_name: BlindBit-macos-arm64

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Install dependencies
        run: go mod download

      - name: Install Fyne CLI
        if: matrix.goos != 'linux' || matrix.goarch != 'arm64'
        run: |
          go install fyne.io/fyne/v2/cmd/fyne@${{ env.FYNE_VERSION }}
        env:
          PATH: ${{ env.PATH }}:$HOME/go/bin

      - name: Install fyne-cross (for Linux ARM64 only)
        if: matrix.goos == 'linux' && matrix.goarch == 'arm64'
        run: |
          go install github.com/fyne-io/fyne-cross@latest
        env:
          PATH: ${{ env.PATH }}:$HOME/go/bin

      # macOS specific setup
      - name: Install macOS dependencies
        if: matrix.goos == 'darwin'
        run: |
          brew install pkg-config glfw || true

      # Linux specific setup
      - name: Install Linux dependencies
        if: matrix.goos == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libgl1-mesa-dev xorg-dev libgtk-3-dev libx11-dev libx11-xcb-dev libxcb-render-util0-dev libxcb-render0-dev libxcb-xkb-dev libxcb-icccm4-dev libxcb-image0-dev libxcb-keysyms1-dev libxcb-randr0-dev libxcb-shape0-dev libxcb-sync-dev libxcb-xfixes0-dev libxcb-xinerama0-dev libxcb-dri3-dev libxcb-cursor-dev libxkbcommon-dev libxkbcommon-x11-dev gcc g++

      # Linux ARM64 uses fyne-cross (via Docker), no manual cross-compilation setup needed

      # Windows specific setup
      - name: Install Windows dependencies
        if: matrix.goos == 'windows'
        run: |
          choco install -y mingw || echo "Mingw install failed, continuing..."

      - name: Set up Go environment
        run: |
          echo "GOOS=${{ matrix.goos }}" >> $GITHUB_ENV
          echo "GOARCH=${{ matrix.goarch }}" >> $GITHUB_ENV
          echo "CGO_ENABLED=1" >> $GITHUB_ENV

      - name: Build and Package (Linux ARM64 with fyne-cross)
        if: matrix.goos == 'linux' && matrix.goarch == 'arm64'
        run: |
          export PATH="$PATH:$HOME/go/bin"
          FYNE_CROSS_CMD="$HOME/go/bin/fyne-cross"
          if [ ! -f "$FYNE_CROSS_CMD" ]; then
            echo "Error: fyne-cross binary not found at $FYNE_CROSS_CMD"
            exit 1
          fi
          $FYNE_CROSS_CMD linux -arch arm64 -output BlindBit ./cmd/blindbit-desktop
        shell: bash

      - name: Build and Package (Native builds)
        if: matrix.goos != 'linux' || matrix.goarch != 'arm64'
        run: |
          export PATH="$PATH:$HOME/go/bin"
          FYNE_CMD="$HOME/go/bin/fyne"
          if [ ! -f "$FYNE_CMD" ]; then
            echo "Error: fyne binary not found at $FYNE_CMD"
            exit 1
          fi
          $FYNE_CMD ${{ matrix.package_cmd }} || {
            if [ "${{ matrix.goos }}" = "darwin" ] && [ "${{ matrix.goarch }}" = "amd64" ]; then
              echo "Warning: macOS Intel build may not be supported on ARM runners"
              exit 0
            else
              exit 1
            fi
          }
          # Windows: According to Fyne docs, Windows packaging requires two builds
          if [ "${{ matrix.goos }}" = "windows" ]; then
            $FYNE_CMD ${{ matrix.package_cmd }} || echo "Second build completed with warnings"
          fi
        shell: bash
        continue-on-error: ${{ matrix.goos == 'darwin' && matrix.goarch == 'amd64' }}

      - name: Create release artifacts directory
        run: mkdir -p release-artifacts
        shell: bash

      # Windows: Copy executable
      - name: Package Windows executable
        if: matrix.goos == 'windows'
        run: |
          if [ -f "BlindBit.exe" ]; then
            mv BlindBit.exe release-artifacts/BlindBit-${{ matrix.goos }}-${{ matrix.goarch }}.exe
          elif [ -f "./cmd/blindbit-desktop/BlindBit.exe" ]; then
            mv ./cmd/blindbit-desktop/BlindBit.exe release-artifacts/BlindBit-${{ matrix.goos }}-${{ matrix.goarch }}.exe
          else
            echo "Error: BlindBit.exe not found"
            exit 1
          fi
        shell: bash

      # Linux: Copy tar archive (fyne package creates .tar.xz or .tar.gz, fyne-cross uses dist/)
      - name: Package Linux tar archive
        if: matrix.goos == 'linux'
        run: |
          ARTIFACT_FOUND=false
          # Check fyne-cross output directory (for ARM64 builds)
          if [ "${{ matrix.goarch }}" = "arm64" ] && [ -d "fyne-cross/dist" ]; then
            TAR_XZ=$(find fyne-cross/dist -name "*.tar.xz" | head -1)
            TAR_GZ=$(find fyne-cross/dist -name "*.tar.gz" | head -1)
            if [ -n "$TAR_XZ" ]; then
              mv "$TAR_XZ" release-artifacts/BlindBit-${{ matrix.goos }}-${{ matrix.goarch }}.tar.xz
              ARTIFACT_FOUND=true
            elif [ -n "$TAR_GZ" ]; then
              mv "$TAR_GZ" release-artifacts/BlindBit-${{ matrix.goos }}-${{ matrix.goarch }}.tar.gz
              ARTIFACT_FOUND=true
            fi
          fi
          # Check standard locations (for native builds)
          if [ "$ARTIFACT_FOUND" = "false" ]; then
            if [ -f "BlindBit.tar.xz" ]; then
              mv BlindBit.tar.xz release-artifacts/BlindBit-${{ matrix.goos }}-${{ matrix.goarch }}.tar.xz
              ARTIFACT_FOUND=true
            elif [ -f "BlindBit.tar.gz" ]; then
              mv BlindBit.tar.gz release-artifacts/BlindBit-${{ matrix.goos }}-${{ matrix.goarch }}.tar.gz
              ARTIFACT_FOUND=true
            elif [ -f "BlindBit.AppImage" ]; then
              mv BlindBit.AppImage release-artifacts/BlindBit-${{ matrix.goos }}-${{ matrix.goarch }}.AppImage
              chmod +x release-artifacts/BlindBit-${{ matrix.goos }}-${{ matrix.goarch }}.AppImage
              ARTIFACT_FOUND=true
            elif [ -f "blindbit-desktop" ]; then
              mv blindbit-desktop release-artifacts/BlindBit-${{ matrix.goos }}-${{ matrix.goarch }}
              chmod +x release-artifacts/BlindBit-${{ matrix.goos }}-${{ matrix.goarch }}
              ARTIFACT_FOUND=true
            fi
          fi
          if [ "$ARTIFACT_FOUND" = "false" ]; then
            echo "Error: No Linux artifacts found"
            exit 1
          fi
        shell: bash

      # macOS: Remove signature from ARM64 builds (to match unsigned Intel builds)
      - name: Remove code signature (ARM64 only)
        if: matrix.goos == 'darwin' && matrix.goarch == 'arm64'
        run: |
          if [ -d "BlindBit.app" ]; then
            BINARY="BlindBit.app/Contents/MacOS/blindbit-desktop"
            if [ -f "$BINARY" ]; then
              # Remove signature from binary
              codesign --remove-signature "$BINARY" || true
              # Remove signature from app bundle
              codesign --remove-signature "BlindBit.app" || true
            fi
          fi
        shell: bash

      # macOS: Copy .app bundle and create .zip
      - name: Package macOS app
        if: matrix.goos == 'darwin'
        run: |
          if [ -d "BlindBit.app" ]; then
            zip -r release-artifacts/BlindBit-${{ matrix.goos }}-${{ matrix.goarch }}.zip BlindBit.app
          else
            echo "Error: BlindBit.app not found"
            exit 1
          fi
        shell: bash

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: release-artifacts/*
          retention-days: 30

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: Prepare release assets
        run: |
          mkdir -p release-assets
          find ./artifacts -type f \( -name "*.exe" -o -name "*.AppImage" -o -name "*.zip" -o -name "*.dmg" -o ! -name "*.txt" \) -exec cp {} release-assets/ \;

      - name: Create checksums
        run: |
          cd release-assets
          for file in *; do
            sha256sum "$file" > "$file.sha256"
          done

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: release-assets/*
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

